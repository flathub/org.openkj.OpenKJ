app-id: org.openkj.OpenKJ
runtime: org.kde.Platform
runtime-version: 5.15-21.08
sdk: org.kde.Sdk
command: openkj
finish-args: 
  - "--share=ipc"
  - "--socket=x11"
  - "--device=dri"
  - "--share=network"
    #  - "--socket=wayland"
  - "--socket=pulseaudio"
  - "--filesystem=host"
  - "--env=LADSPA_PATH=/app/lib/ladspa/"
  - "--env=QT_QPA_PLATFORM=xcb"
  - "--env=GST_PLUGIN_PATH=/app/lib/codecs/lib/gstreamer-1.0"
  - "--env=PATH=/app/lib/totem-pl-parser/bin/:/app/lib/codecs/bin/:/app/bin:/usr/bin"
modules:
  - name: liba52
    config-opts:
      - "--enable-shared"
      - "--disable-static"
    rm-configure: true
    cleanup:
      - "/bin/*a52*"
    sources:
      - type: archive
        url: "http://liba52.sourceforge.net/files/a52dec-0.7.4.tar.gz"
        sha256: a21d724ab3b3933330194353687df82c475b5dfb997513eef4c25de6c865ec33
      - type: patch
        path: patches/a52dec-0.7.4-rpath64.patch
      - type: patch
        path: patches/a52dec-configure-optflags.patch
      - type: patch
        path: patches/liba52-silence.patch
      - type: patch
        path: patches/liba52-prefer-pic.patch
      - type: script
        commands:
          - "autoreconf -fiv"
        dest-filename: autogen.sh
  - name: libmpeg2
    config-opts:
      - "--enable-shared"
      - "--disable-static"
    rm-configure: true
    cleanup:
      - "/bin/*mpeg2*"
    sources:
      - type: archive
        url: "http://libmpeg2.sourceforge.net/files/libmpeg2-0.5.1.tar.gz"
        sha256: dee22e893cb5fc2b2b6ebd60b88478ab8556cb3b93f9a0d7ce8f3b61851871d4
      - type: patch
        path: patches/libmpeg2-inline.patch
      - type: script
        commands:
          - "autoreconf -fiv"
        dest-filename: autogen.sh

  - name: gstreamer
    buildsystem: meson
    config-opts:
      - "--buildtype=release"
      
      - "-Ddoc=disabled"
      - "-Drs=disabled"
      - "-Dgtk_doc=disabled"
      - "-Dpython=disabled"
      - "-Ddevtools=disabled"
      - "-Dges=disabled"
      - "-Drtsp_server=disabled"
      - "-Dgst-examples=disabled"
      - "-Dqt5=disabled"
        
      - "-Dgpl=enabled"
      - "-Dbad=enabled"
      - "-Dugly=enabled"
      - "-Dlibav=enabled"

      - "-Dgst-plugins-ugly:mpeg2dec=enabled"
      - "-Dgst-plugins-bad:openh264=disabled"
      - "-Dgst-plugins-bad:vdpau=disabled"
      - "-Dgst-plugins-bad:vulkan=disabled"
    sources:
      - type: git
        url: "https://gitlab.freedesktop.org/gstreamer/gstreamer.git"
        tag: 1.20.3
        disable-submodules: true
      - type: patch
        path: patches/gst-libav-stop-caching-codecs.patch
    post-install:
      - "mkdir -p /app/lib/codecs/lib/gstreamer-1.0"
      - "mv /app/lib/gstreamer-1.0/*.so /app/lib/codecs/lib/gstreamer-1.0"
      
  - name: libass
    config-opts:
      - "--enable-shared"
      - "--disable-static"
    sources:
      - type: git
        url: "https://github.com/libass/libass.git"
        tag: 0.16.0
      - type: script
        commands:
          - "autoreconf -fiv"
        dest-filename: autogen.sh
  - name: ffmpeg
    cleanup:
      - "/lib/codecs/share/ffmpeg/examples"
    config-opts:
      - "--disable-debug"
      - "--disable-doc"
      - "--disable-static"
      - "--enable-shared"
      - "--enable-nonfree"
      - "--enable-gpl"
    sources:
      - type: git
        url: "https://git.ffmpeg.org/ffmpeg.git"
        tag: n5.1


  - name: rubberband 
    buildsystem: meson
    sources:
      - type: git
        url: https://github.com/breakfastquay/rubberband.git
        tag: v3.0.0

  - name: fmt 
    buildsystem: cmake-ninja
    builddir: yes
    config-opts:
      - "-DFMT_TEST=OFF"
    sources:
      - type: git
        url: https://github.com/fmtlib/fmt.git
        tag: 8.1.1

  - name: spdlog 
    buildsystem: cmake-ninja
    builddir: yes
    config-opts:
      - "-DSPDLOG_BUILD_EXAMPLE=OFF"
      - "-DSPDLOG_BUILD_TESTS=OFF"
    sources:
      - type: git
        url: https://github.com/gabime/spdlog.git
        tag: v1.10.0
        
  - name: taglib 
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/taglib/taglib.git
        commit: 4e7f844ea6439a5a90546feba359832b2ce2e2e8

  - name: OpenKJ
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/openkj/openkj.git
        commit: f116291e50f1fa46acf05135e164abd81d013ee0
cleanup-commands:
  - "mv /app/lib/liba52*.* /app/lib/codecs/lib/"
  - "mv /app/lib/libass.* /app/lib/codecs/lib/"
  - "mkdir -p /app/lib/ffmpeg"
